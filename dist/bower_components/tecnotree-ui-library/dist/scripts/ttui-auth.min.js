/*! TT-UI Lib 0.6.24.19 */
"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="ttui-auth"),function(a,b,c){"use strict";function d(){return{TOKEN_STORAGE:"sessionStorage"}}function e(a,c,d,e,f,g,h,i){function j(a){return g.destroy(),d.$emit("oauth:denied"),e.reject(a)}function k(a){return a.data&&a.data.refresh_token}function l(){return!!g.get()&&!!g.get().access_token}function m(a){return!!a.retry}function n(a){return b.isUndefined(a.headers[c.HTTP_HEADER_NAME])}function o(a){return!k(a)&&(m(a)||n(a))}function p(a,b){var d=c.HTTP_HEADER_VALUE.replace("{{accessToken}}",b);return a.headers[c.HTTP_HEADER_NAME]=d,a}return{request:function(a){return o(a)&&l()&&p(a,g.get().access_token),a},responseError:function(a){return i.isTokenExpired(a.data)?h.doRefresh(a.config):401!==a.status||i.isAuthorized(a)?e.reject(a):j(a)}}}function f(a){function c(b){return b.hasOwnProperty(a.HTTP_HEADER_NAME)&&0===b[a.HTTP_HEADER_NAME].indexOf("Bearer")}this.isAuthorized=function(b){if(!c(b.config.headers))return!0;var d=b.status;return!a.HTTP_ERROR_CODES.some(function(a){return d===a})},this.isTokenExpired=function(a){return!(!a||!a.error)&&(b.isArray(a.error)?a.error.some(function(a){return"REGERR0129"===a.code}):"invalid_token"===a.error)}}function g(a,b){"FakeAuth"===b.AUTH_MODULE&&a.interceptors.push("FakeApiInterceptor")}function h(a,c,d,e,f){var g,h=function(){g=e.get()};return["oauth:authorized","oauth:login","oauth:logout","oauth:loggedOut","oauth:denied","oauth:expired"].forEach(function(a){c.$on(a,h)}),{request:function(c){if(g&&g.access_token&&b.isUndefined(c.headers[a.HTTP_HEADER_NAME])){var d=a.HTTP_HEADER_VALUE.replace("{{accessToken}}",g.access_token);c.headers[a.HTTP_HEADER_NAME]=d}return c},responseError:function(a){return f.isAuthorized(a)||(e.destroy(),c.$emit("oauth:denied")),d.reject(a)}}}function i(a){function b(b){return b.hasOwnProperty(a.HTTP_HEADER_NAME)&&0===b[a.HTTP_HEADER_NAME].indexOf("Bearer")}this.isAuthorized=function(c){if(!b(c.config.headers))return!0;var d=c.status;return d!==a.HTTP_UNAUTHORIZED_CODE&&d!==a.HTTP_BAD_REQUEST_CODE}}function j(a,b){return{logout:function(){a.$emit("oauth:logout"),a.$emit("oauth:loggedOut")},isAuthenticationRequired:function(){return!0},isAuthorized:function(){b.set();var c=b.get();return a.$emit("oauth:authorized",c),!0}}}function k(a,b,c,d,e,f){function g(){return m&&m.$$state.status===p}function h(){k||(k=b.get("$http")),l||(l=b.get("TokenUtils"))}function i(){return l.exchangeRefreshTokenForAccessToken(q).then(l.handleTokenResponse).catch(j)}function j(b){c.error(b),n.destroy(),f.destroy(),a.$emit("oauth:denied")}var k,l,m,n=this,o="refresh_token",p=0,q=null;this.doRefresh=function(a){return h(),a.retry=!0,this.get()?(g()||(m=i()),m.then(k.bind(k,a))):(j(),d.reject())},this.set=function(a){q=a,e[o]=a},this.get=function(){return q},this.update=function(){q=e[o]},this.destroy=function(){this.set(null)}}function l(a,b,c,d,e){var f="previousAppState",g=function(a){return!(!a||!a.name)&&e.STATES_NOT_FOR_STORE.indexOf(a.name)<0};this.setPreviousState=function(a,b){return g(a)?(d.set(f,a.name),a):g(b)?(d.set(f,b.name),b):void 0},this.getPreviousStateName=function(){return d.get(f)},this.removePreviousState=function(){d.remove(f)},this.saveCurrentState=function(){this.setPreviousState(c.current)},b.onbeforeunload=this.saveCurrentState.bind(this),a.$on("$stateChangeStart",function(a,b,c,d){this.setPreviousState(d,b)}.bind(this))}function m(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){var b=h(l.SSO_GET_TOKEN_URI),c=b({codeValue:a});return f.get(c).then(p).then(o).catch(r)}function o(){e.go(k.getPreviousStateName()||l.HOME_STATE)}function p(b){var c=b.data;return u||(u=a.get("RefreshToken")),c.access_token&&c.refresh_token&&400!==c.statusCode?g.when(q(b)):(i.destroy(),u.destroy(),g.reject(b.data))}function q(a){i.setTokenFromString(s(a.data)),u.set(a.data.refresh_token)}function r(a){return d.error(a),j.show("Error","Login error","danger"),e.go(k.getPreviousStateName()||l.HOME_STATE)}function s(a){return"access_token="+a.access_token+"&expires_in="+a.expires_in}function t(){b.$emit(m.HIDE)}var u;this.fetchAccessTokenFromUrl=function(){var a=c.path().replace(/^[\#\/]/,"");i.setTokenFromString(a),e.go(k.getPreviousStateName()||l.HOME_STATE)},this.fetchTokensFromQueryString=function(){var b=c.search(),d=b.access_token,f=b.expires_in,g=b.refresh_token;return d&&f&&g?(u||(u=a.get("RefreshToken")),i.setTokenFromString(s(b)),u.set(g)):j.show("Invalid redirection url"),e.go(l.HOME_STATE)},this.fetchAccessTokenByAuthCode=function(){var a=c.search().code;return a?(b.$emit(m.SHOW),n(a).finally(t)):(j.show("Missing auth code"),e.go(l.HOME_STATE))},this.exchangeRefreshTokenForAccessToken=function(a){return f({method:"POST",url:l.SSO_REFRESH_TOKEN_URI,headers:{"Content-type":"application/json"},data:{refresh_token:a}})},this.handleTokenResponse=p,this.handleLogoutError=function(a){d.error(a),j.show("Error","Logout error","danger")}}var n=b.module("TT-UI.Auth.Config",[]);n.constant("AUTH_CONFIG",d()),n.value("authErrorMessage","Authorization failed. Please login into system."),b.module("TT-UI.Auth.Controllers.Login",["ui.router","oauth","pascalprecht.translate","TT-UI.Config","TT-UI.Auth.Config","TT-UI.Auth.Services.StateHistory","TT-UI.Auth.Services.OAuth"]).config(["$stateProvider",function(a){a.state("login",{url:"/login/",views:{"@":{controller:"LoginCtrl as login",templateUrl:"scripts/auth/views/login.tpl.html"}},data:{authenticatedAccess:!1},label:"Login",onEnter:["$state","$rootScope","CONFIG","StateHistory",function(a,b,c,d){b.userAuthorized&&a.go(d.getPreviousStateName()||c.HOME_STATE)}]})}]).controller("LoginCtrl",["CONFIG","AUTH_CONFIG",function(a,b){this.getSsoUri=function(){return a.SSO_OAUTH_URI},this.getSsoUriPath=function(){return a.SSO_OAUTH_URI_PATH},this.getSsoClientId=function(){return a.SSO_OAUTH_CLIENT_ID},this.getSsoRedirectUri=function(){return a.SSO_OAUTH_REDIRECT_URI},this.getSsoScope=function(){return a.SSO_OAUTH_SCOPE},this.getSsoState=function(){return a.SSO_OAUTH_STATE},this.getSsoProfileUri=function(){return a.SSO_PROFILE_URI},this.getSsoTemplate=function(){return"scripts/auth/views/login-oauth.tpl.html"},this.getSsoResponseType=function(){return"code"!==a.SSO_OAUTH_RESPONSE_TYPE?"token":"code"},this.getStorage=function(){return b.TOKEN_STORAGE}}]),b.module("TT-UI.Auth",["ui.router","oauth","TT-UI.Config","TT-UI.Common.Services.FlashMessage","TT-UI.Auth.Config","TT-UI.Auth.Controllers.Login","TT-UI.Auth.AuthFactory","TT-UI.Auth.Services.StateHistory","TT-UI.Auth.Services.RefreshToken"]).run(["authErrorMessage","$rootScope","$state","FlashMessage","AuthFactory","StateHistory","AccessToken","RefreshToken","Storage","AUTH_CONFIG","CONFIG",function(b,c,d,e,f,g,h,i,j,k,l){var m=f.get(l.AUTH_MODULE);j.use(k.TOKEN_STORAGE);var n=function(){c.userAuthorized=!0},o=function(){c.userAuthorized=!1},p=function(){var a="login";o(),d.current.name!==a&&d.go(a)},q=function(){b&&e.show("Error",b,"danger",!0),p()},r=function(){h.set(),i.update()},s=function(a,b){m.isAuthenticationRequired(b)&&!m.isAuthorized()&&(a.preventDefault(),p())};c.logout=function(){o(),m.logout(),a.localStorage.clear(),g.removePreviousState()},o(),["oauth:authorized","oauth:login","oauth:logout","oauth:loggedOut","oauth:denied","oauth:expired"].forEach(function(a){c.$on(a,r)}),c.$on("oauth:authorized",n),c.$on("oauth:logout",p),c.$on("oauth:loggedOut",p),c.$on("oauth:denied",q),c.$on("$stateChangeStart",s)}]);var n=b.module("TT-UI.Auth.Services.ApiInterceptor",["TT-UI.Auth.Services.OAuth","TT-UI.Auth.Services.ApiResponse","TT-UI.Auth.Services.RefreshToken","TT-UI.Auth.Config"]);e.$inject=["$injector","OAUTH_AUTH","$rootScope","$q","$timeout","AccessToken","RefreshToken","ApiResponse"],n.factory("ApiInterceptor",e);var n=b.module("TT-UI.Auth.Services.ApiResponse",["TT-UI.Auth.Services.OAuth"]);f.$inject=["OAUTH_AUTH"],n.service("ApiResponse",f),b.module("TT-UI.Auth.AuthFactory",["TT-UI.Auth.Services.FakeAuth","TT-UI.Auth.Services.OAuth"]).factory("AuthFactory",["FakeAuth","OAuth",function(a,b){return{get:function(c){switch(c){case"FakeAuth":return a;case"OAuth":default:return b}}}}]);var n=b.module("TT-UI.Auth.Services.FakeAuth",["oauth","TT-UI.Config"]);g.$inject=["$httpProvider","CONFIG"],n.config(g),h.$inject=["OAUTH_AUTH","$rootScope","$q","AccessToken","FakeApiResponse"],n.factory("FakeApiInterceptor",h),i.$inject=["OAUTH_AUTH"],n.service("FakeApiResponse",i),j.$inject=["$rootScope","AccessToken"],n.factory("FakeAuth",j),b.module("TT-UI.Auth.Services.OAuth",["ui.router","oauth","TT-UI.Config","TT-UI.Auth.Services.ApiInterceptor","TT-UI.Auth.Services.TokenUtils","TT-UI.Common.Directives.Spinner"]).constant("AUTH",{ERROR_NOT_AUTH:"$auth.notAuthorized"}).constant("OAUTH_TOKEN_TYPE",{ACCESS:"access_token",REFRESH:"refresh_token"}).constant("OAUTH_AUTH",{HTTP_HEADER_NAME:"Authorization",HTTP_HEADER_VALUE:"Bearer {{accessToken}}",HTTP_ERROR_CODES:[400,401]}).config(["$httpProvider","$stateProvider","CONFIG",function(a,b,c){if("OAuth"===c.AUTH_MODULE){a.interceptors.push("ApiInterceptor");var d={url:"/{accessToken}",onEnter:["TokenUtils",function(a){return a.fetchAccessTokenFromUrl()}],data:{authenticatedAccess:!1}},e={url:"/authcode",onEnter:["TokenUtils",function(a){return a.fetchAccessTokenByAuthCode()}],data:{authenticatedAccess:!1}};"code"===c.SSO_OAUTH_RESPONSE_TYPE?b.state("oauth-code",e):b.state("oauth-token",d),b.state("oauth-update",{url:"/oauth-update",onEnter:["TokenUtils",function(a){return a.fetchTokensFromQueryString()}],data:{authenticatedAccess:!1}})}}]).factory("OAuth",["$rootScope","$interpolate","$http","$window","AccessToken","RefreshToken","TokenUtils","CONFIG","OAUTH_TOKEN_TYPE","SPINNER_EVENTS",function(a,b,c,d,e,f,g,h,i,j){var k,l=function(){a.$emit("oauth:logout"),e.destroy(),f.destroy(),a.$emit("oauth:loggedOut")},m=function(a,b){var c=a.get();return c&&i.ACCESS===b?c[i.ACCESS]:c},n=function(a,c){return b(h.SSO_REVOKE_TOKEN_URI)({tokenType:c,tokenValue:m(a,c)})},o=function(){var b=n(e,i.ACCESS),h=n(f,i.REFRESH);e.destroy(),f.destroy(),a.$emit(j.SHOW),c.get(h).then(c.get.bind(c,b)).then(function(a){d.location.href=a.data}).catch(function(b){a.$emit(j.HIDE),g.handleLogoutError(b),a.$emit("oauth:loggedOut")})};return k="code"===h.SSO_OAUTH_RESPONSE_TYPE?o:l,{logout:k,isAuthenticationRequired:function(a){return!(void 0!==a&&void 0!==a.data&&void 0!==a.data.authenticatedAccess)||a.data.authenticatedAccess},isAuthorized:function(){e.set();var b=e.get();return!(!b||!b.access_token)&&(a.$emit("oauth:authorized",b),!0)}}}]);var n=b.module("TT-UI.Auth.Services.RefreshToken",["ngStorage","TT-UI.Config"]);k.$inject=["$rootScope","$injector","$log","$q","$localStorage","AccessToken"],n.service("RefreshToken",k);var n=b.module("TT-UI.Auth.Services.StateHistory",["angular-storage"]);n.constant("STATE_HISTORY_CONFIG",{STATES_NOT_FOR_STORE:["login","oauth-token","oauth-code","oauth-update"]}),l.$inject=["$rootScope","$window","$state","store","STATE_HISTORY_CONFIG"],n.service("StateHistory",l);var n=b.module("TT-UI.Auth.Services.TokenUtils",["ui.router","oauth","TT-UI.Auth.Services.StateHistory","TT-UI.Auth.Services.RefreshToken","TT-UI.Common.Services.FlashMessage","TT-UI.Common.Directives.Spinner"]);m.$inject=["$injector","$rootScope","$location","$log","$state","$http","$q","$interpolate","AccessToken","FlashMessage","StateHistory","CONFIG","SPINNER_EVENTS"],n.service("TokenUtils",m)}(window,window.angular);
//# sourceMappingURL=ttui-auth.min.js.map